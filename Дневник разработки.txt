16.11.2025
16.55
Сегодня я начал переписывать проект, который делал 2 месяца. Начал я его делать более 3 недель спустя после завершения курса ASP.NET разработчика. Все это время я почти ничего не делал - так, просто читал книги, делал отчеты по практике. Переделать я его решил потомучто я не совсем доволен результатом и хочу сделать следующим образом:
1. Составить новый план архитектуры, учитывающий предыдущие ошибки проектирования.
2. Адаптировать архитектуру под SQRS.
3. Адаптировать архитектуру под микросервисы.
4. Вести разработку по TDD.
5. Попробовать внести больше функционала.
6. Использовать брокеры сообшений для реализации событийного обмена.

Сейчас я немного завис. Я хочу сначала сделать авторизацию, но есть проблема: я опять не знаю, как мне для этого внедрить identity. В необходимости этого шага я уверен, но мне кажется, что из моей предыдущей попытки вышла какая-то каша. Я хочу обмозговать варианты, но дает о себе знать неопытность. Я не могу в голове связать несколько вопросов:
1. Где должна находится вся атрибутика identity.
2. Как конкретно работает Mediatr.
3. Где должны быть ДТО в SQRS и нужны ли контракты, когда его используешь.
4. Как должна проходить грань, отделяющая бизнес-логику и БД.

Делать это через текст проще, поэтому попробую сам себе ответить:
1. Где должна находится вся атрибутика identity?
Очевидно, что identity - это библиотека, реализующая свою бизнес-логику, которая может работать c бд. Все признаки указывают, что ее необходимо поместить на уровень инфраструктуры, но не как простой репозиторий. Ее нужно обернуть в специальный сервис, реализующий интерфейс слоя бизнес логики. В то же время должен быть созданный DBContext, в котором будут описаны действия ef core по настройке сущности пользователя.

Это не вся беда. Мне нужно где-то определить доменную сущность. В слое доменов я это сделать не могу. Я только что пришел к выводу, что мне не нужна доменная сущность пользователя в слое доменов. Коль скоро я буду придерживаться принципа обмена с инфраструктурой через DTO, то мои сервисы ничего о ней знать не должны. Но тут есть проблема - паттерн спецификация. Мне кажется, что он очень хорош. Абстракция IQueriable выглядит невероятно элегантно, но вот в чем дело: если я буду навешивать критерии поиска на левую сущность и на уровне репозитория буду перевешивать ее еще кудп-нибудь, то это будет чистейшая идиотия. Я получу 2 одинаковые сущности, которые нужно будет одновременно изменять. С другой стороны я могу не использовать паннерн спецификации при работе с менеджерами identity. Он является вполне самодостаточным решение и сложные отборы для его непосредственного назначения: аунтефикации/авторизации нахрен не нужны. Но тут встает другой вопрос. А что я буду делать, если мне придется делать такие запросы к самой сущности? Я только что понял, что предыдущие пару предложений не решают проблему ведь я и так не мог использовать спецификациюна менеджерах. Но не суть. Нужно подумать, как дать сервисам доступ к сущности пользователя, не делая сервис зависимым от инфраструктуры.

Я нашел решение. Habr + deepseek в помощь. Короче, для авторизации мне спецификация реально нафиг ненужна, а на случай необходимости ввода каких-либо доп данных можно создать 2-ю сущность пользователя. Они будут добавлятся и удалятся одновременно и будут иметь один первичный ключ. Таким образом спецификация будет реализовываться за счет второй сущности из доменного слоя. Вот и все.

Пришлось конечно на 1.5 часа углубится в изучение DDD, но оно того стоило: я нашел решение задачи и, что еще важнее, конкретно так кайфанул.

На этом моя сегоднешняя работа заканчивается. Сейчас я последние 10-20 минут попробую выполнить часть задумки, а остальное сделаю завтра.
